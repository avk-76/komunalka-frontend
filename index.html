<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ö–æ–º—É–Ω–∞–ª–∫–∞ ‚Ä¢ AVK (standalone v3)</title>
<style>
  :root{--bg:#0b1220;--border:rgba(255,255,255,.08);--muted:#94a3b8}
  html,body{margin:0;height:100%;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1120px;margin:0 auto;padding:16px 20px 60px}
  .card{background:rgba(2,6,23,.7);border:1px solid var(--border);border-radius:16px;padding:16px;backdrop-filter:saturate(120%) blur(6px)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  .grid-5{grid-template-columns:repeat(1,1fr)}
  .grid-3{grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){.grid-5{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:1024px){.grid-5{grid-template-columns:repeat(5,1fr)} .grid-3{grid-template-columns:repeat(3,1fr)}}
  .btn{border:1px solid var(--border);background:#0b1324;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .select{appearance:none;background:#0e182b;color:#fff;border:1px solid var(--border);padding:8px 28px 8px 10px;border-radius:10px}
  .title{color:#fff;font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .apt-title{font-size:16px;line-height:1.2;min-height:40px}
  .apt-hint{font-size:14px}
  .num{font-variant-numeric:tabular-nums}
  .aptbtn{border:1px solid var(--border);background:#0e1627;border-radius:14px;padding:14px;text-align:left;color:#e2e8f0;cursor:pointer;display:flex;flex-direction:column;gap:6px}
  .aptbtn:hover{border-color:rgba(255,255,255,.16)}
  .aptbtn.active{border-color:rgba(6,182,212,.5);background:#0b1426}
  .header{position:relative;overflow:hidden;border:1px solid var(--border);border-radius:16px;background:linear-gradient(to bottom,#0d172a,#0d172a,#0a1220)}
  .header .content{position:relative;z-index:2;padding:18px}
  .aurora{position:absolute;inset:-20%;filter:blur(40px);opacity:.75}
  .blob{position:absolute;width:60vmin;height:60vmin;border-radius:40% 60% 55% 45% / 55% 45% 55% 45%;
        background:radial-gradient(circle at 30% 30%, rgba(6,182,212,.25), transparent 60%),
                   radial-gradient(circle at 70% 60%, rgba(99,102,241,.25), transparent 60%);
        animation: blobMove 18s ease-in-out infinite}
  .blob.b2{left:60%;top:-10%;animation-delay:-6s}
  .blob.b1{left:-10%;top:10%}
  @keyframes blobMove{0%{transform:translate(0,0) scale(1)}50%{transform:translate(6%,-4%) scale(1.1)}100%{transform:translate(0,0) scale(1)}}
  .thinbar{grid-column:span 2;background:linear-gradient(90deg,rgba(34,211,238,.12),rgba(79,70,229,.12));border:1px solid rgba(34,211,238,.3);border-radius:12px;padding:6px 12px;display:flex;justify-content:space-between;align-items:center;height:32px;align-self:start;justify-self:stretch;margin:0}
  @media(max-width:1019px){.thinbar{grid-column:span 2;background:linear-gradient(90deg,rgba(34,211,238,.12),rgba(79,70,229,.12));border:1px solid rgba(34,211,238,.3);border-radius:12px;padding:6px 12px;display:flex;justify-content:space-between;align-items:center;height:32px;align-self:start;justify-self:stretch;margin:0}}
  .type-tag{font-size:11px;border:1px solid rgba(255,255,255,.14);border-radius:6px;padding:2px 6px;color:#cbd5e1;background:#0d1930}
  .form-wrap{border:1px dashed var(--border);border-radius:16px;padding:16px;background:rgba(2,6,23,.55);margin-bottom:12px}
  .form-grid{display:grid;gap:12px;grid-template-columns:repeat(1,1fr)}
  @media(min-width:860px){.form-grid{grid-template-columns:repeat(2,1fr)}}
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:13px;color:#cbd5e1}
  .input{background:#0b1324;color:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .pill{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:#0e1627}
  .fixed-list{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
  .section-h{font-weight:800;color:#e5e7eb;margin:4px 0 8px 0}
  .hint{font-size:12px;color:#94a3b8}
  .savebar{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  .btn.primary{background:#0ea5e9}
  .btn.primary:disabled{opacity:.5}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#0b1324;border:1px solid var(--border);border-radius:16px;padding:16px;max-width:520px;width:92%}
  .row.spc{justify-content:space-between}

</style>

<style>
/* Boost brand/title size in header */
header .brand, .brand, .hdr .title, .topbar .title { font-size: 26px !important; }
/* Remove any '‚Äî –±–∞–∑–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞' style banners if still present via CSS fallback */
.badge-filled, .period-status, .top-right-note { display: none !important; }
</style>

<style>
#btnSendTG .tg-icn{ vertical-align: -3px; margin-left: 8px; display: inline-block; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="aurora"><div class="blob b1"></div><div class="blob b2"></div></div>
      <div class="content row">
        <div class="title" style="font-size:18px">–ö–æ–º—É–Ω–∞–ª–∫–∞ ‚Ä¢ AVK</div>
        <div class="muted" style="margin-left:auto">–ß–µ—Ä–≤–µ–Ω—å 2025 ‚Äî –±–∞–∑–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞</div>
      </div>
    </div>

    <div style="height:8px"></div>
    <div id="apt-list" class="grid grid-5"></div>

    <div style="height:10px"></div>

    <div class="row">
      <div class="card row">
        <span class="muted" style="font-size:14px;">–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥</span>
        <select id="month" class="select"></select>
        <select id="year" class="select"></select>
      </div>
      <button id="csv" class="btn">‚¨á –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
      <button id="sendimg" class="btn">üì∏ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —è–∫ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</button>
    </div>

    <div style="height:10px"></div>
    <div id="entry-form"></div>
    <div id="details" class="card"></div>
  </div>

<script>
const MONTHS_UA=["–°—ñ—á–µ–Ω—å","–õ—é—Ç–∏–π","–ë–µ—Ä–µ–∑–µ–Ω—å","–ö–≤—ñ—Ç–µ–Ω—å","–¢—Ä–∞–≤–µ–Ω—å","–ß–µ—Ä–≤–µ–Ω—å","–õ–∏–ø–µ–Ω—å","–°–µ—Ä–ø–µ–Ω—å","–í–µ—Ä–µ—Å–µ–Ω—å","–ñ–æ–≤—Ç–µ–Ω—å","–õ–∏—Å—Ç–æ–ø–∞–¥","–ì—Ä—É–¥–µ–Ω—å"];
const $=(s,e=document)=>e.querySelector(s);
const toUAH=n=>n.toLocaleString("uk-UA",{minimumFractionDigits:2,maximumFractionDigits:2});
const periodKey=(y,m)=>y+"-"+String(m+1).padStart(2,"0");
function computeItemCost(it){ if(it.kind==="fixed"||it.kind==="variable") return it.tariff.fixed||0; const used=(it.curr||0)-(it.prev||0); return Math.max(0,used)*(it.tariff.price||0); }

const aptCatalog=[
  {id:"b-hmel",title:"–ë. –•–º–µ–ª—å–Ω–∏—Ü—å–∫–æ–≥–æ 8–µ/20"},
  {id:"mechnykova",title:"–ú–µ—á–Ω—ñ–∫–æ–≤–∞ 5/20"},
  {id:"salak",title:"–ú. –°–∞–ª–∞–∫—É–Ω–æ–≤–∞ 12/5"},
  {id:"sevast",title:"–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å—Å—å–∫–∞ 67–ê/2"},
  {id:"hetmanska",title:"–ì–µ—Ç—å–º–∞–Ω—Å—å–∫–∞ 50/178"},
];

const dataByPeriod={"2025-06": {
    "b-hmel": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 1000, "curr": 1150, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 500, "curr": 600, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 62, "curr": 69, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "gas", "label": "üî• –ì–∞–∑", "prev": 83, "curr": 85, "tariff": {"unit": "–º¬≥", "price": 7.89}, "kind": "meter"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 9000.0}, "kind": "fixed"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}, {"key": "ap_gas_fix", "label": "üî• –ê–ü –ì–∞–∑", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 3.51}, "kind": "fixed"}, {"key": "intercom", "label": "üîî –î–æ–º–æ—Ñ–æ–Ω", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 70.0}, "kind": "fixed"}, {"key": "zheu", "label": "üßæ –ñ–Ñ–£", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 328.92}, "kind": "fixed"}, {"key": "trash", "label": "üóëÔ∏è –°–º—ñ—Ç—Ç—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 33.57}, "kind": "fixed"}, {"key": "internet", "label": "üì∂ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 260.0}, "kind": "fixed"}, {"key": "ap_heat", "label": "üî• –ê–ü –û–ø–∞–ª–µ–Ω–Ω—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 35.0}, "kind": "fixed"}],
    "mechnykova": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 17655, "curr": 17775, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 7964, "curr": 8013, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "osbb", "label": "üè¢ –û–°–ë–ë", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 1450.0}, "kind": "variable"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 18000.0}, "kind": "fixed"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}],
    "salak": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 19104, "curr": 19256, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 5286, "curr": 5388, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 1391, "curr": 1399, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 10500.0}, "kind": "fixed"}, {"key": "osbb", "label": "üè¢ –û–°–ë–ë", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 477.08}, "kind": "fixed"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}, {"key": "ap_heat", "label": "üî• –ê–ü –û–ø–∞–ª–µ–Ω–Ω—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 27.42}, "kind": "fixed"}],
    "sevast": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 1644, "curr": 1765, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 866, "curr": 998, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 384, "curr": 387, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "water2", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 2", "prev": 254, "curr": 256, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "gas", "label": "üî• –ì–∞–∑", "prev": 10208, "curr": 10221, "tariff": {"unit": "–º¬≥", "price": 7.89}, "kind": "meter"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}, {"key": "ap_gas_fix", "label": "üî• –ê–ü –ì–∞–∑", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 101.96}, "kind": "fixed"}],
    "hetmanska": null
  }, "2025-07": {"b-hmel": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 1773, "curr": 1873, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 455, "curr": 485, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 130, "curr": 133, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "gas", "label": "üî• –ì–∞–∑", "prev": 62, "curr": 64, "tariff": {"unit": "–º¬≥", "price": 7.89}, "kind": "meter"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 9000.0}, "kind": "fixed"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}, {"key": "ap_gas_fix", "label": "üî• –ê–ü –ì–∞–∑", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 3.51}, "kind": "fixed"}, {"key": "intercom", "label": "üîî –î–æ–º–æ—Ñ–æ–Ω", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 70.0}, "kind": "fixed"}, {"key": "zheu", "label": "üßæ –ñ–Ñ–£", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 328.92}, "kind": "fixed"}, {"key": "trash", "label": "üóëÔ∏è –°–º—ñ—Ç—Ç—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 33.57}, "kind": "fixed"}, {"key": "internet", "label": "üì∂ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 260.0}, "kind": "fixed"}, {"key": "ap_heat", "label": "üî• –ê–ü –û–ø–∞–ª–µ–Ω–Ω—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 35.0}, "kind": "fixed"}], "mechnykova": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 17755, "curr": 17948, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 8013, "curr": 8094, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 316, "curr": 319, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "osbb", "label": "üè¢ –û–°–ë–ë", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 1643.0}, "kind": "variable"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 18000.0}, "kind": "fixed"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}], "salak": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 19256, "curr": 19426, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 5388, "curr": 5495, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 1399, "curr": 1406, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 10500.0}, "kind": "fixed"}, {"key": "osbb", "label": "üè¢ –û–°–ë–ë", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 477.08}, "kind": "fixed"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}, {"key": "ap_heat", "label": "üî• –ê–ü –û–ø–∞–ª–µ–Ω–Ω—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 27.42}, "kind": "fixed"}], "sevast": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 1765, "curr": 1980, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 998, "curr": 1298, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 387, "curr": 390, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "water2", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 2", "prev": 256, "curr": 262, "tariff": {"unit": "–º¬≥", "price": 31.36}, "kind": "meter"}, {"key": "gas", "label": "üî• –ì–∞–∑", "prev": 10241, "curr": 10246, "tariff": {"unit": "–º¬≥", "price": 7.89}, "kind": "meter"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.0}, "kind": "fixed"}, {"key": "ap_gas_fix", "label": "üî• –ê–ü –ì–∞–∑", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 101.96}, "kind": "fixed"}], "hetmanska": [{"key": "light_day", "label": "üîÜ –°–≤—ñ—Ç–ª–æ –î–µ–Ω—å", "prev": 9159, "curr": 9316, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 4.32}, "kind": "meter"}, {"key": "light_night", "label": "üåô –°–≤—ñ—Ç–ª–æ –ù—ñ—á", "prev": 2849, "curr": 3005, "tariff": {"unit": "–∫–í—Ç¬∑–≥–æ–¥", "price": 2.16}, "kind": "meter"}, {"key": "water1", "label": "üíß –í–æ–¥–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫ 1", "prev": 1068, "curr": 1076, "tariff": {"unit": "–º¬≥", "price": 89.91}, "kind": "meter"}, {"key": "ap_water_fix", "label": "üíß –ê–ü –í–æ–¥–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 56.14}, "kind": "fixed"}, {"key": "gas", "label": "üî• –ì–∞–∑", "prev": 1612, "curr": 1616, "tariff": {"unit": "–º¬≥", "price": 7.96}, "kind": "meter"}, {"key": "ap_gas_fix", "label": "üî• –ê–ü –ì–∞–∑", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 16.36}, "kind": "fixed"}, {"key": "ap_heat", "label": "üî• –ê–ü –û–ø–∞–ª–µ–Ω–Ω—è", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 38.8}, "kind": "fixed"}, {"key": "osbb", "label": "üè¢ –û–°–ë–ë", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 209.8}, "kind": "fixed"}, {"key": "rent", "label": "üè† –û—Ä–µ–Ω–¥–Ω–∞ –ø–ª–∞—Ç–∞", "tariff": {"unit": "–≥—Ä–Ω/–º—ñ—Å", "fixed": 8500.0}, "kind": "fixed"}]}};

let currentAptId=aptCatalog[0].id;
let currentMonth = 7; // –õ–∏–ø–µ–Ω—å
let currentYear=2025;

function getItemsFor(aptId,y,m){
  const key=periodKey(y,m);
  const p=dataByPeriod[key];
  return p && p[aptId] ? JSON.parse(JSON.stringify(p[aptId])) : null;
}

function renderAptList(){
  const host=document.getElementById("apt-list"); host.innerHTML="";
  const key=periodKey(currentYear,currentMonth);
  aptCatalog.forEach(ap=>{
    const has=!!(dataByPeriod[key] && dataByPeriod[key][ap.id]);
    const hint= has ? "–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –¥–∞–Ω—ñ" : "–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ";
    const btn=document.createElement("button");
    btn.className="aptbtn"+(ap.id===currentAptId?" active":"");
    btn.innerHTML=`<div class="apt-title title">${ap.title}</div><div class="apt-hint muted">${hint}</div>`;
    btn.onclick=()=>{currentAptId=ap.id; renderAptList(); renderDetails();};
    host.appendChild(btn);
  });
}

function renderSelectors(){
  const mSel=document.getElementById("month"), ySel=document.getElementById("year");
  mSel.innerHTML=MONTHS_UA.map((m,i)=>`<option value="${i}" ${i===currentMonth?"selected":""}>${m}</option>`).join("");
  const years=Array.from({length:6},(_,k)=>2023+k);
  ySel.innerHTML=years.map(y=>`<option value="${y}" ${y===currentYear?"selected":""}>${y}</option>`).join("");
  mSel.onchange=e=>{currentMonth=+e.target.value; renderAptList(); renderDetails();};
  ySel.onchange=e=>{currentYear=+e.target.value; renderAptList(); renderDetails();};
}

function tileHTML(it){
  const used = it.kind==="meter"? Math.max(0,(it.curr||0)-(it.prev||0)) : null;
  const cost = computeItemCost(it);
  const typeTag = it.kind==="meter" ? "–õ—ñ—á–∏–ª—å–Ω–∏–∫" : (it.kind==="variable" ? "–ó–º—ñ–Ω–Ω–∞" : "–§—ñ–∫—Å–æ–≤–∞–Ω–∞");
  const lines = it.kind==="meter"
    ? `<div class="muted">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ: <span class="num" style="color:#e2e8f0">${it.prev}</span> ${it.tariff.unit}</div>
       <div class="muted">–ü–æ—Ç–æ—á–Ω—ñ: <span class="num" style="color:#e2e8f0">${it.curr}</span> ${it.tariff.unit}</div>
       <div class="muted">–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è: <span class="num" style="color:#22c55e">${used}</span> ${it.tariff.unit}</div>
       <div class="muted">–¢–∞—Ä–∏—Ñ: <span class="num" style="color:#e2e8f0">${(it.tariff.price||it.tariff.fixed)}</span> ${it.kind==="meter"?"–≥—Ä–Ω/"+it.tariff.unit:"–≥—Ä–Ω/–º—ñ—Å"}</div>`
    : (it.kind==="variable" ? `<div class="muted">–ó–º—ñ–Ω–Ω–∞ —Å—É–º–∞ –Ω–∞ –º—ñ—Å—è—Ü—å</div>` : `<div class="muted">–§—ñ–∫—Å–æ–≤–∞–Ω–∞ —Å—É–º–∞</div>`);
  return `<div class="card tile">
    <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:6px">
      <h4 class="title" style="margin:0">${it.label}</h4>
      <span class="type-tag">${typeTag}</span>
    </div>
    ${lines}
    <div class="title num" style="margin-top:8px;font-size:18px">${toUAH(cost)} –≥—Ä–Ω</div>
  </div>`;
}







function prevPeriodKey(y,m){
  // return the nearest previous period key that exists in dataByPeriod
  let d=new Date(y,m,1); d.setMonth(d.getMonth()-1);
  for(let i=0;i<24;i++){
    const k=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    if(dataByPeriod[k]) return k;
    d.setMonth(d.getMonth()-1);
  }
  return null;
}

function renderEntryForm(ap){
  const key=periodKey(currentYear,currentMonth);
  const host=document.getElementById("entry-form");
  host.innerHTML="";
  // If the period already has data for this apt -> hide form
  const existing = dataByPeriod[key] && dataByPeriod[key][ap.id];
  if(existing) { host.innerHTML=""; return; }

  // Determine previous items for this apt
  // Prefer previous period if available, else the latest earlier period that has this apt.
  let prevK = prevPeriodKey(currentYear,currentMonth);
  let prevItems=null;
  while(prevK){
    if(dataByPeriod[prevK] && dataByPeriod[prevK][ap.id]) { prevItems = JSON.parse(JSON.stringify(dataByPeriod[prevK][ap.id])); break; }
    const [yy,mm]=prevK.split("-").map(Number); prevK = prevPeriodKey(yy,mm-1);
  }
  if(!prevItems){ host.innerHTML = '<div class="card">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è.</div>'; return; }

  const meters = prevItems.filter(i=>i.kind==="meter");
  const fixed = prevItems.filter(i=>i.kind==="fixed");
  const variables = prevItems.filter(i=>i.kind==="variable");

  // Build form HTML
  let form = `<div class="form-wrap">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="section-h">–í–Ω–µ—Å–µ–Ω–Ω—è –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ ‚Äì ${MONTHS_UA[currentMonth]} ${currentYear} —Ä.</div>
      <div class="hint">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤–∑—è—Ç—ñ –∑ ${MONTHS_UA[+prevK.split('-')[1]-1]} ${prevK.split('-')[0]} —Ä.</div>
    </div>
    <div class="form-grid">`;

  meters.forEach((it,idx)=>{
    const usedPrev = it.curr; // Previous month's current -> becomes "–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π"
    form += `<div class="card">
      <div class="title" style="font-size:16px;margin-bottom:8px">${it.label}</div>
      <div class="field"><label class="label">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫ (${it.tariff.unit})</label>
         <input class="input" type="number" inputmode="decimal" id="prev_${idx}" value="${usedPrev}" disabled></div>
      <div class="field"><label class="label">–ü–æ—Ç–æ—á–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫ (${it.tariff.unit})</label>
         <input class="input meter-input" data-idx="${idx}" data-key="${it.key}" type="number" inputmode="decimal" placeholder="0.00"></div>
      <div class="hint">–¢–∞—Ä–∏—Ñ: ${(it.tariff.price||0)} –≥—Ä–Ω –∑–∞ ${it.tariff.unit}</div>
    </div>`;
  });
  form += `</div>`;

  if(variables.length){
    form += `<div class="section-h" style="margin-top:12px"></div>
      <div class="form-grid">`;
    variables.forEach((it,vidx)=>{
      form += `<div class="card"><div class="title" style="font-size:16px;margin-bottom:8px">${it.label}</div>
        <div class="field"><label class="label">–°—É–º–∞ (–≥—Ä–Ω)</label>
        <input class="input var-input" data-vkey="${it.key}" type="number" inputmode="decimal" value="${(it.tariff.fixed||0)}"></div></div>`;
    });
    form += `</div>`;
  }

  if(fixed.length){
    form += `<div class="section-h" style="margin-top:12px">–ü–æ—Å—Ç—ñ–π–Ω—ñ –ø–ª–∞—Ç–µ–∂—ñ</div>
      <div class="fixed-list">`+ fixed.map(it=>`<div class="pill"><div class="muted">${it.label}</div><div class="title num" style="font-size:16px">${(it.tariff.fixed||0).toLocaleString("uk-UA",{minimumFractionDigits:2,maximumFractionDigits:2})} –≥—Ä–Ω</div></div>`).join("") + `</div>`;
  }

  form += `<div style="height:10px"></div>
    <div class="savebar">
      <button id="calcSave" class="btn primary" disabled>–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ç–∞ –∑–±–µ—Ä–µ–≥—Ç–∏</button>
      <div class="hint">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤.</div>
    </div>
  </div>`;

  host.innerHTML = form;

  function validate(){
    const allFilled = [...document.querySelectorAll(".meter-input")].every(inp => inp.value !== "");
    document.getElementById("calcSave").disabled = !allFilled;
  }
  document.querySelectorAll(".meter-input").forEach(inp=> inp.addEventListener("input", validate));
  validate();

  document.getElementById("calcSave").onclick = ()=>{
    // Build new items from prevItems + inputs
    const newItems = [];
    meters.forEach((it,idx)=>{
      const currVal = parseFloat(document.querySelector(`.meter-input[data-idx="${idx}"]`).value||"0");
      const newIt = {key:it.key,label:it.label,prev:it.curr,curr:currVal,tariff:it.tariff,kind:"meter"};
      newItems.push(newIt);
    });
    variables.forEach((it)=>{
      const valEl = document.querySelector(`.var-input[data-vkey="${it.key}"]`);
      const amt = valEl? parseFloat(valEl.value||"0") : 0;
      newItems.push({key:it.key,label:it.label,tariff:{unit:"–≥—Ä–Ω/–º—ñ—Å",fixed:amt},kind:"variable"});
    });
    fixed.forEach(it=> newItems.push(it));

    const k = key;
    dataByPeriod[k] = dataByPeriod[k] || {};
    dataByPeriod[k][ap.id] = newItems;

    // Clear form and show details
    host.innerHTML = "";
    renderAptList();
    renderDetails();
  };
}

function renderDetails(){
  const showFormIfNeeded = ()=>{
    const ap=aptCatalog.find(a=>a.id===currentAptId);
    const key=periodKey(currentYear,currentMonth);
    if(!(dataByPeriod[key] && dataByPeriod[key][ap.id])){ renderEntryForm(ap); } else { document.getElementById('entry-form').innerHTML=''; }
  };
  const ap=aptCatalog.find(a=>a.id===currentAptId);
  const items=getItemsFor(ap.id,currentYear,currentMonth);
  const csvBtn=document.getElementById("csv");
  const periodLabel=`${MONTHS_UA[currentMonth]} ${currentYear} —Ä.`;
  let html=`<div class="row" style="justify-content:space-between;gap:8px">
    <div class="title" style="font-size:18px">${ap.title}</div>
    <div class="muted">${periodLabel}</div>
  </div><div style="height:8px"></div>`;

  if(items && items.length){
    const get = (k)=>items.find(i=>i.key===k);
    const day=get("light_day"), night=get("light_night");
    const w1=get("water1"), w2=get("water2");
    const gas=get("gas"), apWater=get("ap_water_fix"), apGas=get("ap_gas_fix");

    const lightSum=(day?computeItemCost(day):0)+(night?computeItemCost(night):0);
    const waterSum=(w1?computeItemCost(w1):0)+(w2?computeItemCost(w2):0);
    const total=items.reduce((s,it)=>s+computeItemCost(it),0);

    if(ap.id==="sevast"){
      const tileAt=(it,style)=> it? `<div style="${style}">${tileHTML(it)}</div>` : "";
      let grid = `<div class="grid grid-3">`;
      // Row 1
      grid += tileAt(day,   "grid-column:1");
      grid += tileAt(night, "grid-column:2");
      grid += tileAt(gas,   "grid-column:3");
      // Row 2: light summary
      grid += `<div class="thinbar" style="grid-column:1 / span 2;"><div class="title" style="font-size:15px">–ó–∞–≥–∞–ª–æ–º —Å–≤—ñ—Ç–ª–æ</div><div class="title num" style="font-size:17px">${toUAH(lightSum)} –≥—Ä–Ω</div></div>`;
      // Row 3: waters + AP Water
      grid += tileAt(w1, "grid-column:1");
      grid += tileAt(w2, "grid-column:2");
      grid += tileAt(apWater, "grid-column:3");
      // Row 4: water summary + AP Gas (right next to sum)
      grid += `<div class="thinbar" style="grid-column:1 / span 2;"><div class="title" style="font-size:15px">–ó–∞–≥–∞–ª–æ–º –≤–æ–¥–∞</div><div class="title num" style="font-size:17px">${toUAH(waterSum)} –≥—Ä–Ω</div></div>`;
      grid += tileAt(apGas, "grid-column:3");
      // Any other items
      const used=[day,night,gas,w1,w2,apWater,apGas].filter(Boolean);
      const others = items.filter(it => !used.includes(it));
      html+= grid + others.map(tileHTML).join("") + `</div>`;
    } else {
      const rest=items.filter(i=>i.key!=="light_day" && i.key!=="light_night");
      html+=`<div class="grid grid-3">
        ${day?tileHTML(day):""}
        ${night?tileHTML(night):""}
        ${rest[0]? tileHTML(rest[0]).replace('class="card tile"','class="card tile" style="grid-row:span 2"') : ""}
        <div class="thinbar"><div class="title" style="font-size:15px">–ó–∞–≥–∞–ª–æ–º —Å–≤—ñ—Ç–ª–æ</div><div class="title num" style="font-size:17px">${toUAH(lightSum)} –≥—Ä–Ω</div></div>
        ${rest.slice(1).map(tileHTML).join("")}
      </div>`;
    }

    html+=`<div style="height:12px"></div>
      <div class="row" style="justify-content:flex-end">
        <div class="card" style="background:#0e1627"><div class="muted" style="font-size:13px">–í—Å—å–æ–≥–æ –¥–æ —Å–ø–ª–∞—Ç–∏</div><div class="title num" style="font-size:22px">${toUAH(total)} –≥—Ä–Ω</div></div>
      </div>`;

    csvBtn.disabled=false;
    csvBtn.onclick=()=>{
      const rows=[["–ü–æ—Å–ª—É–≥–∞","–¢–∏–ø","–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ","–ü–æ—Ç–æ—á–Ω—ñ","–û–¥–∏–Ω–∏—Ü—ñ","–¢–∞—Ä–∏—Ñ/–§—ñ–∫—Å","–°—É–º–∞"]];
      items.forEach(it=>{
        const unit= it.tariff.unit||"–º—ñ—Å";
        const tariff = it.kind==="meter"?it.tariff.price:it.tariff.fixed;
        const cost=computeItemCost(it);
        rows.push([it.label, it.kind, it.prev||"", it.curr||"", unit, tariff, cost]);
      });
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=`komunalka_${ap.id}_${periodKey(currentYear,currentMonth)}.csv`; a.click();
      URL.revokeObjectURL(url);
    };
  } else {
    html+=`<div class="card" style="border-style:dashed">–î–∞–Ω–∏—Ö –∑–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ –ø–æ–∫–∏ –Ω–µ–º–∞—î. <b>–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ</b>, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫.</div>`;
    csvBtn.disabled=true; csvBtn.onclick=null;
  }
  document.getElementById("details").innerHTML=html;
  showFormIfNeeded();
}

renderAptList();




 renderSelectors(); renderDetails();
</script>

<div id="imgModal" class="modal">
  <div class="box">
    <div class="row spc" style="align-items:center">
      <div class="title" style="font-size:16px">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏/–∑–±–µ—Ä–µ–≥—Ç–∏ —Å–∫—Ä—ñ–Ω —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</div>
      <button id="closeModal" class="btn">‚úñ</button>
    </div>
    <div style="height:10px"></div>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <button id="btnDownloadPNG" class="btn primary">‚¨á –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG</button>
      <button id="btnCopyClipboard" class="btn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —É –±—É—Ñ–µ—Ä</button>
    </div>
    <div style="height:12px"></div>
    <div class="card">
      <div class="section-h">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Telegram <button id="cfgBtn" class="btn" type="button" style="margin-left:8px;padding:6px 10px">‚öô</button></div>
      
<div class="form-grid">
  <div class="field" id="tgTokenRow">
    <label class="label">Bot Token (–∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —ñ —Å—Ö–æ–≤–∞—î—Ç—å—Å—è)</label>
    <input id="tgToken" class="input" placeholder="–í—Å—Ç–∞–≤—Ç–µ —Ç–æ–∫–µ–Ω –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –∑–±–µ—Ä–µ–∂–µ–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ">
    <div class="hint">–©–æ–± –∑–º—ñ–Ω–∏—Ç–∏ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚öô —Å–ø—Ä–∞–≤–∞ –≤—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫—É.</div>
  </div>

  <div class="field">
    <label class="label">–û–¥–µ—Ä–∂—É–≤–∞—á (–∫–≤–∞—Ä—Ç–∏—Ä–∞)</label>
    <select id="aptSelect" class="input">
      <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –æ–¥–µ—Ä–∂—É–≤–∞—á–∞ ‚Äî</option>
      <option value="551405030" data-name="–ë. –•–º–µ–ª—å–Ω–∏—Ü—å–∫–æ–≥–æ 8–µ/20">–ë. –•–º–µ–ª—å–Ω–∏—Ü—å–∫–æ–≥–æ 8–µ/20</option>
      <option value="338787777" data-name="–ú–µ—á–Ω—ñ–∫–æ–≤–∞ 5/20">–ú–µ—á–Ω—ñ–∫–æ–≤–∞ 5/20</option>
      <option value="5074929397" data-name="–ú. –°–∞–ª–∞–∫—É–Ω–æ–≤–∞ 12/5">–ú. –°–∞–ª–∞–∫—É–Ω–æ–≤–∞ 12/5</option>
      <option value="254073924" data-name="–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å—Å—å–∫–∞ 67–ê/2">–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å—Å—å–∫–∞ 67–ê/2</option>
      <option value="863294114" data-name="–ì–µ—Ç—å–º–∞–Ω—Å—å–∫–∞ 50/178">–ì–µ—Ç—å–º–∞–Ω—Å—å–∫–∞ 50/178</option>
      <option value="manual" data-name="–í–∫–∞–∑–∞—Ç–∏ –≤—Ä—É—á–Ω—É">–í–∫–∞–∑–∞—Ç–∏ –≤—Ä—É—á–Ω—É‚Ä¶</option>
    </select>
  </div>

  <div class="field">
    <label class="label">Chat ID</label>
    <input id="tgChat" class="input" placeholder="–ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –∑ –≤–∏–±–æ—Ä—É –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –≤—Ä—É—á–Ω—É">
  </div>
</div>

      <div style="height:8px"></div>
      <div class="field"><label class="label">–ü—ñ–¥–ø–∏—Å (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</label><input id="tgCaption" class="input" placeholder="–°–∫—Ä—ñ–Ω —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∫–æ–º—É–Ω–∞–ª–∫–∏"></div>
      <div style="height:10px"></div>
      <button id="btnSendTG" class="btn">‚û° –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤ Telegram <svg class="tg-icn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="18" height="18" aria-hidden="true">
  <defs><linearGradient id="g" x1="0.66" y1="0.11" x2="0.34" y2="0.89">
    <stop offset="0" stop-color="#37aee2"/><stop offset="1" stop-color="#1e96c8"/>
  </linearGradient></defs>
  <circle cx="120" cy="120" r="120" fill="url(#g)"/>
  <path d="M193 69c3 1 4 5 1 7l-20 94c-1 6-8 8-12 5l-33-24-18 17c-2 2-5 3-7 3l3-37 67-60c3-3-1-4-4-2l-83 52-35-11c-6-2-6-10 1-12l137-53c2-1 3-1 4-1z" fill="#fff"/>
</svg></button>
      <div id="tgStatus" class="hint" style="margin-top:8px"></div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
  const modal = document.getElementById('imgModal');
  const openBtn = document.getElementById('sendimg');
  const closeBtn = document.getElementById('closeModal');
  const detailsEl = document.getElementById('details');
  const monthSel = document.getElementById('month');
  const yearSel = document.getElementById('year');
  const tgStatus = document.getElementById('tgStatus');

  function periodKeyLabel(){
    const m = parseInt(monthSel.value,10);
    const y = parseInt(yearSel.value,10);
    return `${MONTHS_UA[m]} ${y}`;
  }

  function captureDetails(){
    const node = detailsEl;
    const rect = node.getBoundingClientRect();
    return html2canvas(node, {
      backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg') || '#0b1220',
      scale: window.devicePixelRatio > 1 ? 2 : 1,
      useCORS: true,
      windowWidth: document.documentElement.scrollWidth,
      windowHeight: document.documentElement.scrollHeight
    });
  }

  function fileBaseName(){
    const apTitle = (detailsEl.querySelector('.row .title')?.textContent || 'apt').replace(/[\s\/\\:]+/g,'_');
    const period = periodKeyLabel().replace(/[\s\/\\:]+/g,'_');
    return `komunalka_${apTitle}_${period}`;
  }

  async function toBlob(canvas){
    return new Promise(res=>canvas.toBlob(res));
  }

  openBtn?.addEventListener('click', ()=>{ modal.classList.add('show'); tgStatus.textContent=''; });
  closeBtn?.addEventListener('click', ()=>{ modal.classList.remove('show'); });

  document.getElementById('btnDownloadPNG')?.addEventListener('click', async ()=>{
    const canvas = await captureDetails();
    const blob = await toBlob(canvas);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileBaseName() + '.png';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnCopyClipboard')?.addEventListener('click', async ()=>{
    try{
      const canvas = await captureDetails();
      canvas.toBlob(async (blob)=>{
        const item = new ClipboardItem({ [blob.type]: blob });
        await navigator.clipboard.write([item]);
        tgStatus.textContent = '‚úÖ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–µ —É –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.';
      });
    }catch(e){
      tgStatus.textContent = '‚ùó –ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —É –±—É—Ñ–µ—Ä (–æ–±–º–µ–∂–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞).';
    }
  });

  document.getElementById('btnSendTG')?.addEventListener('click', async ()=>{
    let token = (getStoredToken() || document.getElementById('tgToken')?.value.trim() || '');
    const chatId = document.getElementById('tgChat').value.trim();
    const caption = document.getElementById('tgCaption').value.trim() || ('–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞ ' + getPeriodLabel());
    if(!token || !chatId){
      tgStatus.textContent = '‚ùó –í–∫–∞–∂—ñ—Ç—å Bot Token —ñ Chat ID.'; return;
    }
    tgStatus.textContent = '‚è≥ –ì–æ—Ç—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è‚Ä¶';
    try{
      const canvas = await captureDetails();
      const blob = await toBlob(canvas);
      const fd = new FormData();
      fd.append('chat_id', chatId);
      fd.append('caption', caption);
      fd.append('photo', new File([blob], fileBaseName()+'.png', {type: 'image/png'}));
      const resp = await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, { method:'POST', body: fd });
      if(!resp.ok){ throw new Error('HTTP '+resp.status); }
      const json = await resp.json();
      if(json.ok){
        tgStatus.textContent = '‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram.';
      } else {
        tgStatus.textContent = '‚ùó –ü–æ–º–∏–ª–∫–∞ Telegram: ' + (json.description || '–Ω–µ–≤—ñ–¥–æ–º–æ');
      }
    }catch(err){
      tgStatus.textContent = '‚ùó –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏: ' + err.message;
    }
  });
})();
</script>


<script>
const TOKEN_KEY = 'komunalka_bot_token';
function getStoredToken(){ try{ return localStorage.getItem(TOKEN_KEY) || ''; }catch(e){ return ''; } }
function setStoredToken(v){ try{ localStorage.setItem(TOKEN_KEY, v||''); }catch(e){} }

function initLocalTokenUI(){
  const row = document.getElementById('tgTokenRow');
  const inp = document.getElementById('tgToken');
  const btn = document.getElementById('cfgBtn');
  if(!row || !inp || !btn) return;
  const existing = getStoredToken();
  if(existing){ row.style.display = 'none'; }
  inp.addEventListener('change', ()=>{
    if(inp.value.trim()){
      setStoredToken(inp.value.trim());
      row.style.display = 'none';
    }
  });
  btn.addEventListener('click', ()=>{
    row.style.display = (row.style.display==='none') ? '' : 'none';
  });
}

function initAptSelect(){
  const sel = document.getElementById('aptSelect');
  const chat = document.getElementById('tgChat');
  const cap = document.getElementById('tgCaption');
  if(!sel || !chat) return;
  sel.addEventListener('change', ()=>{
    const opt = sel.options[sel.selectedIndex];
    const val = sel.value;
    const name = opt?.dataset?.name || '';
    if(val && val!=='manual'){
      chat.value = val;
      if(cap && !cap.value){ cap.value = '–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞ ' + getPeriodLabel(); }
    } else if(val==='manual'){ chat.value = ''; }
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  initLocalTokenUI();
  initAptSelect();
});
</script>

<script>
function getPeriodLabel(){
  try{
    if (typeof periodKeyLabel === 'function') {
      return periodKeyLabel();
    }
  }catch(e){}
  // Fallbacks: try to read visible month/year controls
  const mSel = document.querySelector('select[name="month"], select#month, [data-role="month"] select, [data-testid="month"] select') || document.querySelector('select');
  const ySel = document.querySelector('select[name="year"], select#year, [data-role="year"] select, [data-testid="year"] select');
  const m = mSel && mSel.options && mSel.selectedIndex >= 0 ? mSel.options[mSel.selectedIndex].text.trim() : '';
  const y = ySel && ySel.options && ySel.selectedIndex >= 0 ? ySel.options[ySel.selectedIndex].text.trim() : '';
  return (m && y) ? (m + ' ' + y) : (m || y || '');
}
</script>

<script>
(function(){
  const AUTO_PREFIX = '–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞ ';
  function updateCaptionByPeriod(forcePrefix=false){
    var cap = document.getElementById('tgCaption');
    if(!cap) return;
    var current = (cap.value||'').trim();
    var label = (typeof getPeriodLabel==='function') ? getPeriodLabel() : '';
    var next = AUTO_PREFIX + (label||'');
    if(forcePrefix || current==='' || current.startsWith(AUTO_PREFIX)){
      cap.value = next.trim();
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    // initial
    updateCaptionByPeriod(false);
    // on any select change (month/year selectors usually are selects)
    document.querySelectorAll('select').forEach(sel=>{
      sel.addEventListener('change', ()=>updateCaptionByPeriod(false));
    });
    // on Download PNG (exact id from our UI)
    var dl = document.getElementById('btnDownloadPNG');
    if(dl){ dl.addEventListener('click', ()=>updateCaptionByPeriod(false)); }
    // generic click fallback: if user clicks near period controls, delay-update
    document.body.addEventListener('click', (e)=>{
      if(e.target.closest('[data-role="month"],[data-role="period"],.chip,.pill,.btn,.select')){
        setTimeout(()=>updateCaptionByPeriod(false), 0);
      }
    });
  });
})();
</script>

<script>
function removeFilledBanner(){
  const nodes = Array.from(document.querySelectorAll('body *'))
    .filter(el => el.childElementCount === 0 && /‚Äî\s*–±–∞–∑–∞\s*–∑–∞–ø–æ–≤–Ω–µ–Ω–∞/i.test(el.textContent||''));
  nodes.forEach(n => { const p = n.closest('div,span,section,header') || n; try{ p.remove(); }catch(e){ n.remove(); } });
}
document.addEventListener('DOMContentLoaded', removeFilledBanner);
</script>
</body>
</html>
